<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fraction Hunter</title>
<style>
  body { margin:0; overflow:hidden; font-family:Arial, sans-serif; background:#e0f7fa; user-select:none; }
  canvas { position:absolute; top:0; left:0; z-index:1; }
  #levelSelect {
    position:absolute; top:50%; left:50%;
    transform:translate(-50%, -50%);
    font-size:24px;
    background:rgba(255,255,255,0.95);
    padding:20px; border-radius:15px; text-align:center;
    z-index:10;
  }
  button { font-size:20px; margin:10px; padding:10px 20px; cursor:pointer; }
</style>
</head>
<body>

<div id="levelSelect">
  <h2>Select Level</h2>
  <button onclick="startGame(1)">Level 1: 1/2, 1/3, 1/4</button>
  <button onclick="startGame(2)">Level 2: 1/2, 1/3, 1/4, 2/3, 2/4, 3/4</button>
</div>

<audio id="ding" src="https://freesound.org/data/previews/522/522858_9454746-lq.mp3"></audio>
<audio id="chime" src="https://freesound.org/data/previews/348/348411_3248244-lq.mp3"></audio>
<audio id="finalSound" src="https://freesound.org/data/previews/250/250629_4486188-lq.mp3" preload="auto"></audio>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const ding = document.getElementById('ding');
const chime = document.getElementById('chime');
const finalSound = document.getElementById('finalSound');

ding.volume = 0.5;
chime.volume = 0.5;
finalSound.volume = 0.6;

let level = 1, score = 0, timeLeft = 60;
let shapes = [], sparkles = [], wrongClicks = [];
let restartButton = null;
const numShapes = 4, shapeSize = 80; // reduced to 4 shapes
let speed = 0.75; // 50% slower
let timerInterval;
let gameOver = false;

const boxWidth = canvas.width * 0.9;
const boxHeight = canvas.height * 0.9;
const boxX = (canvas.width - boxWidth)/2;
const boxY = (canvas.height - boxHeight)/2;
const infoBoxHeight = 50;

let mouseX = 0, mouseY = 0;
let targetFraction = '';
let pulseTime = 0;

const shapesTypes = ['circle','square','rectangle'];
const pastelColors = [
  'rgba(255,179,186,1)',
  'rgba(255,223,186,1)',
  'rgba(255,255,186,1)',
  'rgba(186,255,201,1)',
  'rgba(186,225,255,1)'
];

function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function generateShapes(){
  shapes = [];
  wrongClicks = [];
  let positions = [];
  let correctIndex = randomInt(0,numShapes-1);

  let currentFractions = (level===1)
    ? ['1/2','1/3','1/4']
    : ['1/2','1/3','1/4','2/3','2/4','3/4'];

  targetFraction = currentFractions[randomInt(0,currentFractions.length-1)];

  for(let i=0;i<numShapes;i++){
    let fraction = (i===correctIndex)? targetFraction : (()=>{
      let f;
      do { f=currentFractions[randomInt(0,currentFractions.length-1)]; } while(f===targetFraction);
      return f;
    })();

    let shapeType = shapesTypes[randomInt(0,shapesTypes.length-1)];
    let color = pastelColors[randomInt(0,pastelColors.length-1)];
    let x,y,tries=0;
    do{
      x=randomInt(boxX+shapeSize,boxX+boxWidth-shapeSize);
      y=randomInt(boxY+infoBoxHeight+shapeSize,boxY+boxHeight-shapeSize);
      tries++;
    } while(positions.some(p=>Math.hypot(p.x-x,p.y-y)<shapeSize*2) && tries<100);
    positions.push({x,y});
    let angle=Math.random()*2*Math.PI;
    let vx=Math.cos(angle)*speed, vy=Math.sin(angle)*speed;
    shapes.push({x, y, vx, vy, fraction, shapeType, correct: i===correctIndex, color});
  }

  let utterance = new SpeechSynthesisUtterance(targetFraction);
  speechSynthesis.speak(utterance);
}

function createSparkles(x,y){
  for(let i=0;i<20;i++){
    let angle=Math.random()*2*Math.PI; let spd=Math.random()*3+1;
    sparkles.push({x,y,vx:Math.cos(angle)*spd,vy:Math.sin(angle)*spd,life:30+randomInt(0,15),color:`hsl(${Math.random()*360},100%,70%)`});
  }
}

function updateShapes(){
  if(gameOver) return;
  for(let i=0;i<shapes.length;i++){
    let s=shapes[i];
    s.vx+=(Math.random()-0.5)*0.05;
    s.vy+=(Math.random()-0.5)*0.05;
    let mag=Math.hypot(s.vx,s.vy);
    if(mag>speed){ s.vx=(s.vx/mag)*speed; s.vy=(s.vy/mag)*speed; }
    s.x+=s.vx; s.y+=s.vy;

    if(s.x<boxX+shapeSize){s.x=boxX+shapeSize;s.vx*=-1;}
    if(s.x>boxX+boxWidth-shapeSize){s.x=boxX+boxWidth-shapeSize;s.vx*=-1;}
    if(s.y<boxY+infoBoxHeight+shapeSize){s.y=boxY+infoBoxHeight+shapeSize;s.vy*=-1;}
    if(s.y>boxY+boxHeight-shapeSize){s.y=boxY+boxHeight-shapeSize;s.vy*=-1;}

    for(let j=i+1;j<shapes.length;j++){
      let s2=shapes[j]; let dx=s2.x-s.x; let dy=s2.y-s.y; let dist=Math.hypot(dx,dy);
      if(dist<shapeSize*2){ let angle=Math.atan2(dy,dx); let overlap=shapeSize*2-dist;
        s.x-=Math.cos(angle)*overlap/2; s.y-=Math.sin(angle)*overlap/2;
        s2.x+=Math.cos(angle)*overlap/2; s2.y+=Math.sin(angle)*overlap/2;
      }
    }
  }
  for(let i=sparkles.length-1;i>=0;i--){ let s=sparkles[i]; s.x+=s.vx; s.y+=s.vy; s.life--; if(s.life<=0) sparkles.splice(i,1);}
}

function drawShape(s){
  ctx.save();
  ctx.translate(s.x, s.y);
  ctx.lineWidth = 2;
  const totalParts = parseInt(s.fraction.split('/')[1]);
  const shadedParts = parseInt(s.fraction.split('/')[0]); 
  const color = s.color;

  ctx.shadowColor = color;
  ctx.shadowBlur = 8;

  if(s.shapeType==='circle'){
    const radius = shapeSize;
    let startAngle = -Math.PI/2;
    const sliceAngle = 2*Math.PI/totalParts;
    for(let i=0;i<totalParts;i++){
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,radius,startAngle,startAngle+sliceAngle);
      ctx.closePath();
      ctx.fillStyle = (i<shadedParts)? color : 'white';
      ctx.fill();
      ctx.strokeStyle = 'black';
      ctx.stroke();
      startAngle += sliceAngle;
    }
  } else if(s.shapeType==='square' || s.shapeType==='rectangle'){
    const w = shapeSize*2;
    const h = shapeSize*2;
    const partWidth = w / totalParts;
    for(let i=0;i<totalParts;i++){
      ctx.beginPath();
      ctx.rect(-w/2 + i*partWidth, -h/2, partWidth, h);
      ctx.fillStyle = (i<shadedParts)? color : 'white';
      ctx.fill();
      ctx.strokeStyle = 'black';
      ctx.stroke();
    }
  }

  ctx.restore();
  ctx.shadowBlur = 0;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle='rgba(255,255,255,0.8)';
  ctx.fillRect(boxX,boxY,boxWidth,boxHeight);
  ctx.strokeStyle='black'; ctx.lineWidth=4; ctx.strokeRect(boxX,boxY,boxWidth,boxHeight);

  ctx.fillStyle='rgba(255,255,255,0.9)';
  ctx.fillRect(boxX,boxY,boxWidth,infoBoxHeight);
  ctx.strokeStyle='black'; ctx.lineWidth=3; ctx.strokeRect(boxX,boxY,boxWidth,infoBoxHeight);

  ctx.fillStyle='red'; ctx.font='24px Arial'; ctx.textAlign='left'; ctx.fillText(`Score: ${score}`, boxX+20, boxY+35);
  ctx.textAlign='right'; ctx.fillText(`Time: ${timeLeft}`, boxX+boxWidth-20, boxY+35);

  pulseTime+=0.05;
  const scale = 1 + 0.1*Math.sin(pulseTime*2);
  const colorValue = Math.floor(127+128*Math.sin(pulseTime));
  const color = `rgb(${255-colorValue},0,${colorValue})`;
  ctx.save();
  ctx.font=`bold ${28*scale}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.shadowColor=color; ctx.shadowBlur=15;
  ctx.fillStyle=color;
  ctx.fillText('FRACTION HUNTER', boxX+boxWidth/2, boxY+35);
  ctx.restore();

  shapes.forEach(s=>drawShape(s));

  wrongClicks.forEach(w=>{
    const s=w.shape;
    ctx.strokeStyle='red'; ctx.lineWidth=5; ctx.beginPath();
    ctx.moveTo(s.x-shapeSize,s.y-shapeSize); ctx.lineTo(s.x+shapeSize,s.y+shapeSize);
    ctx.moveTo(s.x+shapeSize,s.y-shapeSize); ctx.lineTo(s.x-shapeSize,s.y+shapeSize); ctx.stroke();
  });

  sparkles.forEach(sp=>{
    ctx.beginPath(); ctx.arc(sp.x,sp.y,3,0,2*Math.PI); ctx.fillStyle=sp.color; ctx.fill();
  });

  if(!gameOver && targetFraction){
    const padding = 12;
    ctx.font='18px Arial';
    const textWidth = ctx.measureText(targetFraction).width;
    const boxW = textWidth + padding*2;
    const boxH = 48;
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.strokeStyle='black'; ctx.lineWidth=2;
    ctx.fillRect(mouseX-boxW/2,mouseY+20,boxW,boxH);
    ctx.strokeRect(mouseX-boxW/2,mouseY+20,boxW,boxH);
    ctx.fillStyle='black'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(targetFraction,mouseX,mouseY+44);
  }

  if(gameOver){
    const boxW=300, boxH=140;
    const boxXCenter=boxX+(boxWidth-boxW)/2;
    const boxYBottom=boxY+boxHeight-boxH-20;
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillRect(boxXCenter,boxYBottom,boxW,boxH);
    ctx.strokeStyle='black'; ctx.lineWidth=3; ctx.strokeRect(boxXCenter,boxYBottom,boxW,boxH);
    ctx.fillStyle='red'; ctx.font='28px Arial'; ctx.textAlign='center';
    ctx.fillText(`Time's up!`,boxXCenter+boxW/2,boxYBottom+40);
    ctx.fillText(`Your score: ${score}`,boxXCenter+boxW/2,boxYBottom+75);

    const btnW=120, btnH=35;
    const btnX=boxXCenter+(boxW-btnW)/2; const btnY=boxYBottom+95;
    ctx.fillStyle='#4CAF50'; ctx.fillRect(btnX,btnY,btnW,btnH);
    ctx.strokeStyle='black'; ctx.strokeRect(btnX,btnY,btnW,btnH);
    ctx.fillStyle='white'; ctx.font='20px Arial';
    ctx.fillText('Restart',btnX+btnW/2,btnY+btnH/2+7);
    restartButton={x:btnX,y:btnY,w:btnW,h:btnH};
  }
}

function handleClick(e){
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left;
  const my=e.clientY-rect.top;

  if(gameOver && restartButton){
    if(mx>=restartButton.x && mx<=restartButton.x+restartButton.w &&
       my>=restartButton.y && my<=restartButton.y+restartButton.h){
      resetGame(); return;
    }
  }

  shapes.forEach(s=>{
    let dist=Math.hypot(mx-s.x,my-s.y);
    if(dist<shapeSize){
      if(s.correct){ score++; createSparkles(s.x,s.y); ding.play(); chime.play(); generateShapes(); wrongClicks=[]; }
      else { wrongClicks.push({shape:s}); }
    }
  });
}

function resetGame(){
  gameOver=false; shapes=[]; wrongClicks=[]; sparkles=[];
  score=0; timeLeft=60;
  document.getElementById('levelSelect').style.display='block';
  restartButton=null;
}

function gameLoop(){ updateShapes(); draw(); requestAnimationFrame(gameLoop); }

function startGame(selectedLevel){
  level=selectedLevel;
  document.getElementById('levelSelect').style.display='none';
  generateShapes(); canvas.addEventListener('click',handleClick);
  gameLoop(); timeLeft=60;

  timerInterval=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      gameOver=true;
      let utterance=new SpeechSynthesisUtterance(`Your final score is ${score}`);
      speechSynthesis.speak(utterance);
      utterance.onend=()=>{ finalSound.play(); };
    }
  },1000);
}

canvas.addEventListener('mousemove', (e)=>{
  const rect=canvas.getBoundingClientRect();
  mouseX=e.clientX-rect.left;
  mouseY=e.clientY-rect.top;
});
</script>
</body>
</html>
